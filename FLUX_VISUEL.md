# Flux Visuel - Redirection Abonnement ExpirÃ© vers Paiement Stripe

## ğŸ”„ Flux Complet en Diagramme DÃ©taillÃ©

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         FLUX DE PAIEMENT COMPLET                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£  PAGE DE LOGIN                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚         ERP BTP - Connexion                          â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Nom d'utilisateur: [  test           ]             â”‚                â”‚
â”‚  â”‚  Mot de passe:      [  â—â—â—â—â—â—        ]             â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  [ Se connecter ] [S'inscrire]                       â”‚                â”‚
â”‚  â”‚  [Mot de passe oubliÃ© ?]                            â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                            â”‚
â”‚  ğŸ”„ ACTION: Utilisateur clique "Se connecter"                            â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ POST /
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£  AUTHENTIFICATION & VÃ‰RIFICATION D'ABONNEMENT (Backend)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/ui/panels/auth.py                                       â”‚
â”‚  â””â”€ MÃ©thode: _handle_login()                                             â”‚
â”‚                                                                            â”‚
â”‚  âœ“ Appel: auth_manager.authenticate("test", "password")                 â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/core/auth.py                                            â”‚
â”‚  â””â”€ MÃ©thode: authenticate()                                              â”‚
â”‚     â”œâ”€ âœ“ Cherche user par username/email                                 â”‚
â”‚     â”œâ”€ âœ“ VÃ©rifie mot de passe                                            â”‚
â”‚     â”œâ”€ âœ“ VÃ©rifie statut utilisateur                                      â”‚
â”‚     â””â”€ âœ“ Appel subscription_service.check_subscription()                 â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/services/subscription_service.py                        â”‚
â”‚  â””â”€ MÃ©thode: check_subscription("test")                                  â”‚
â”‚     â”œâ”€ Connexion BD externe (176.131.66.167:5433)                        â”‚
â”‚     â”œâ”€ Query: SELECT FROM abonnements WHERE client_id = 'test@email.com' â”‚
â”‚     â”œâ”€ VÃ©rification date_fin_essai < TODAY()  â†’ âš ï¸ EXPIRÃ‰!              â”‚
â”‚     â””â”€ âŒ RETOUR: (False, "Votre abonnement a expirÃ©...")                 â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“¤ RETOUR Ã  _handle_login():                                            â”‚
â”‚     Result = (User, "", "Votre abonnement a expirÃ©...")                  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ error_message != None
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£  REDIRECTION VERS PAGE DE PAIEMENT                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/ui/panels/auth.py                                       â”‚
â”‚  â””â”€ MÃ©thode: _handle_login()                                             â”‚
â”‚                                                                            â”‚
â”‚     if error_message:                                                     â”‚
â”‚         client_id = user.email if user.email else username               â”‚
â”‚         ui.navigate.to(f'/renew-subscription?client_id={client_id}')     â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“ NOUVELLE URL: /renew-subscription?client_id=test@example.com         â”‚
â”‚                                                                            â”‚
â”‚  ğŸ”„ ACTION: Redirection cÃ´tÃ© frontend (navigation instantanÃ©e)           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Naviguer vers /renew-subscription
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£  PAGE DE SÃ‰LECTION DU PLAN DE PAIEMENT                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  âš ï¸  Votre abonnement a expirÃ©                            â”‚            â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚  â”‚ Choisissez un plan pour continuer Ã  utiliser ERP BTP     â”‚            â”‚
â”‚  â”‚                                                          â”‚            â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
â”‚  â”‚ â”‚     Mensuel         â”‚    â”‚  ğŸ†  Annuel             â”‚ â”‚            â”‚
â”‚  â”‚ â”‚                     â”‚    â”‚                          â”‚ â”‚            â”‚
â”‚  â”‚ â”‚      49â‚¬/mois       â”‚    â”‚  499â‚¬/an                â”‚ â”‚            â”‚
â”‚  â”‚ â”‚      (30 jours)     â”‚    â”‚  (365 jours)            â”‚ â”‚            â”‚
â”‚  â”‚ â”‚                     â”‚    â”‚                          â”‚ â”‚            â”‚
â”‚  â”‚ â”‚ âœ“ AccÃ¨s complet     â”‚    â”‚ âœ“ AccÃ¨s complet         â”‚ â”‚            â”‚
â”‚  â”‚ â”‚ âœ“ Support priorit.  â”‚    â”‚ âœ“ Support priorit.      â”‚ â”‚            â”‚
â”‚  â”‚ â”‚                     â”‚    â”‚ âœ“ 2 mois offerts        â”‚ â”‚            â”‚
â”‚  â”‚ â”‚                     â”‚    â”‚ ğŸ’° Ã‰conomisez 89â‚¬/an    â”‚ â”‚            â”‚
â”‚  â”‚ â”‚ [Pas sÃ©lectionnÃ©]   â”‚    â”‚ [Pas sÃ©lectionnÃ©]       â”‚ â”‚            â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
â”‚  â”‚                                                          â”‚            â”‚
â”‚  â”‚ [ ğŸ’³ ProcÃ©der au paiement ]      [ Retour ]            â”‚            â”‚
â”‚  â”‚                                                          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: main.py                                                     â”‚
â”‚  â””â”€ Route: @ui.page('/renew-subscription')                               â”‚
â”‚                                                                            â”‚
â”‚  ğŸ”„ ACTIONS UTILISATEUR:                                                 â”‚
â”‚     1. Cliquer sur une card (Mensuel ou Annuel)                          â”‚
â”‚        â””â”€ La card change: border-blue-500, bg-blue-50                    â”‚
â”‚     2. Cliquer "ProcÃ©der au paiement"                                    â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Clic "ProcÃ©der au paiement"
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£  CRÃ‰ATION SESSION STRIPE (Backend)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: main.py                                                     â”‚
â”‚  â””â”€ Fonction: proceed_to_payment()                                       â”‚
â”‚     â”œâ”€ Valide: selected_plan != None                                     â”‚
â”‚     â””â”€ Appel: stripe_service.create_checkout_session(...)                â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/services/stripe_service.py                              â”‚
â”‚  â””â”€ MÃ©thode: create_checkout_session()                                   â”‚
â”‚     â”œâ”€ Valide le plan (mensuel ou annuel)                                â”‚
â”‚     â”œâ”€ Appel API Stripe:                                                 â”‚
â”‚     â”‚  POST https://api.stripe.com/v1/checkout/sessions                  â”‚
â”‚     â”‚  â”œâ”€ payment_method_types: ['card']                                 â”‚
â”‚     â”‚  â”œâ”€ line_items:                                                    â”‚
â”‚     â”‚  â”‚  â”œâ”€ price: 4900 ou 49900 (centimes)                             â”‚
â”‚     â”‚  â”‚  â””â”€ quantity: 1                                                 â”‚
â”‚     â”‚  â”œâ”€ customer_email: test@example.com                               â”‚
â”‚     â”‚  â”œâ”€ success_url: /payment-success?session_id={CHECKOUT_SESSION_ID} â”‚
â”‚     â”‚  â””â”€ cancel_url: /renew-subscription?client_id=test@example.com     â”‚
â”‚     â”‚                                                                      â”‚
â”‚     â””â”€ RETOUR: checkout_url (URL Stripe)                                 â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“¤ RETOUR Ã  proceed_to_payment():                                       â”‚
â”‚     checkout_url = "https://checkout.stripe.com/pay/cs_xxx..."           â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Redirection JavaScript
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6ï¸âƒ£  PAGE STRIPE CHECKOUT                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  ğŸ”’ Stripe Checkout                                 â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  RÃ©sumÃ© de la commande                              â”‚                â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚                â”‚
â”‚  â”‚  Abonnement Annuel ERP BTP       ......    499.00â‚¬   â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Total                                      499.00â‚¬   â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Email                                              â”‚                â”‚
â”‚  â”‚  [test@example.com                ]                â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Informations de facturation                        â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Pays/RÃ©gion                                        â”‚                â”‚
â”‚  â”‚  [France                           â–¼]              â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  NumÃ©ro de carte                                    â”‚                â”‚
â”‚  â”‚  [4242  4242  4242  4242         ]                 â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Date d'expiration                CVC               â”‚                â”‚
â”‚  â”‚  [12 / 26]                      [123]              â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Nom sur la carte                                   â”‚                â”‚
â”‚  â”‚  [Test User                        ]                â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  [ Payer 499.00â‚¬ ]                                  â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  [ Retour vers le marchand ]                        â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                            â”‚
â”‚  ğŸ”„ ACTION: Utilisateur remplit et valide le paiement                    â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Paiement validÃ© par Stripe
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7ï¸âƒ£  TRAITEMENT PAIEMENT STRIPE                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ”„ CÃ”TÃ‰ STRIPE:                                                         â”‚
â”‚     â”œâ”€ Validation de la carte bancaire                                   â”‚
â”‚     â”œâ”€ VÃ©rification CVV et adresse                                       â”‚
â”‚     â”œâ”€ DÃ©bitage compte                                                   â”‚
â”‚     â””â”€ CrÃ©ation session checkout avec statut "completed"                 â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“¤ WEBHOOK VERS VOTRE SERVEUR:                                          â”‚
â”‚     Ã‰vÃ©nement: checkout.session.completed                                â”‚
â”‚     POST https://votre-domaine.com/api/stripe/webhook                    â”‚
â”‚     â”œâ”€ Headers: Stripe-Signature (vÃ©rification)                          â”‚
â”‚     â””â”€ Body: JSON avec dÃ©tails session                                   â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Webhook reÃ§u
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8ï¸âƒ£  WEBHOOK TRAITEMENT & MISE Ã€ JOUR BD (Backend)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: main.py                                                     â”‚
â”‚  â””â”€ Route: POST /api/stripe/webhook                                      â”‚
â”‚     â”œâ”€ âœ“ RÃ©cupÃ©rer signature Stripe-Signature                            â”‚
â”‚     â”œâ”€ âœ“ VÃ©rifier signature avec STRIPE_WEBHOOK_SECRET                   â”‚
â”‚     â”œâ”€ âœ“ Deserialiser payload JSON                                       â”‚
â”‚     â”œâ”€ âœ“ VÃ©rifier event.type == 'checkout.session.completed'             â”‚
â”‚     â”œâ”€ âœ“ Extraire donnÃ©es:                                               â”‚
â”‚     â”‚  â”œâ”€ session.id                                                     â”‚
â”‚     â”‚  â”œâ”€ session.client_reference_id (client_id)                        â”‚
â”‚     â”‚  â”œâ”€ session.customer_email                                         â”‚
â”‚     â”‚  â””â”€ session.metadata (contient le plan)                            â”‚
â”‚     â”‚                                                                      â”‚
â”‚     â””â”€ âœ“ Appel subscription_service.handle_payment_success()             â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/services/subscription_service.py                        â”‚
â”‚  â””â”€ MÃ©thode: handle_payment_success()                                    â”‚
â”‚     â”œâ”€ Connexion BD externe                                              â”‚
â”‚     â”œâ”€ UPDATE abonnements                                                â”‚
â”‚     â”‚  â”œâ”€ SET date_fin_essai = NOW() + 30 (mensuel) ou 365 (annuel)      â”‚
â”‚     â”‚  â””â”€ SET statut = 'actif'                                           â”‚
â”‚     â”‚     WHERE client_id = 'test@example.com'                           â”‚
â”‚     â”‚                                                                      â”‚
â”‚     â””â”€ âœ“ Retour: (True, "Abonnement mis Ã  jour")                        â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“Š RÃ‰SULTAT EN BD:                                                      â”‚
â”‚     id       | client_id           | date_fin_essai | statut              â”‚
â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚     123      | test@example.com    | 2027-01-21     | actif               â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Redirection automatique
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9ï¸âƒ£  PAGE DE SUCCÃˆS DE PAIEMENT                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚                         ğŸ‰                           â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚          PAIEMENT RÃ‰USSI !                          â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Merci pour votre achat.                            â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  Votre abonnement Annuel                            â”‚                â”‚
â”‚  â”‚  est maintenant actif.                              â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚                â”‚
â”‚  â”‚  DÃ©tails de l'abonnement                            â”‚                â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚                â”‚
â”‚  â”‚  Plan: Abonnement Annuel                            â”‚                â”‚
â”‚  â”‚  Montant: 499.00â‚¬                                   â”‚                â”‚
â”‚  â”‚  DurÃ©e: 365 jours                                   â”‚                â”‚
â”‚  â”‚  Expire le: 21 janvier 2027                         â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  NumÃ©ro de transaction: pi_xxx                      â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â”‚  [ âœ… AccÃ©der Ã  l'application ]                      â”‚                â”‚
â”‚  â”‚  [ ğŸ“„ TÃ©lÃ©charger la facture ]                       â”‚                â”‚
â”‚  â”‚                                                       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: main.py                                                     â”‚
â”‚  â””â”€ Route: GET /payment-success                                          â”‚
â”‚                                                                            â”‚
â”‚  ğŸ”„ ACTION: Utilisateur clique "AccÃ©der Ã  l'application"                 â”‚
â”‚     Redirection vers /dashboard ou page d'accueil                        â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Clic "AccÃ©der Ã  l'application"
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”Ÿ RECONNEXION & ACCÃˆS Ã€ L'APPLICATION                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Option 1: Via le lien "AccÃ©der Ã  l'application"                        â”‚
â”‚            â””â”€ Redirection directe vers le dashboard                      â”‚
â”‚                                                                            â”‚
â”‚  Option 2: Via une nouvelle connexion                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“ Aller Ã : /login                                                      â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚         ERP BTP - Connexion                          â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ Nom d'utilisateur: [test           ]               â”‚                â”‚
â”‚  â”‚ Mot de passe:      [â—â—â—â—â—â—        ]               â”‚                â”‚
â”‚  â”‚ [ Se connecter ]                                    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/core/auth.py                                            â”‚
â”‚  â””â”€ MÃ©thode: authenticate()                                              â”‚
â”‚     â”œâ”€ âœ“ VÃ©rifier identifiants                                           â”‚
â”‚     â”œâ”€ âœ“ Appel check_subscription()                                      â”‚
â”‚     â”‚  â””â”€ BD: date_fin_essai = 2027-01-21 âœ“ VALIDE!                     â”‚
â”‚     â”œâ”€ âœ“ RETOUR: (User, session_id, None)  â† Pas d'erreur!              â”‚
â”‚     â””â”€ CrÃ©ation session                                                  â”‚
â”‚                                                                            â”‚
â”‚  ğŸ“„ Fichier: erp/ui/panels/auth.py                                       â”‚
â”‚  â””â”€ MÃ©thode: _handle_login()                                             â”‚
â”‚     â””â”€ on_login_success(session_id, username)  â† Connexion OK!          â”‚
â”‚                                                                            â”‚
â”‚  âœ… RÃ‰SULTAT:                                                            â”‚
â”‚     â”œâ”€ Pas de redirection vers /renew-subscription                       â”‚
â”‚     â”œâ”€ Session crÃ©Ã©e                                                     â”‚
â”‚     â””â”€ AccÃ¨s Ã  l'application granted                                     â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ âœ… Connexion rÃ©ussie
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… TABLEAU DE BORD / APPLICATION                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Utilisateur authentifiÃ© et accÃ¨s Ã  l'application ERP BTP                â”‚
â”‚                                                                            â”‚
â”‚  Abonnement actif jusqu'au 21 janvier 2027                               â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š RÃ©sumÃ© des Appels API

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰tape           â”‚ MÃ©thode & URL    â”‚ Acteur           â”‚ RÃ©sultat     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Login        â”‚ POST /           â”‚ Frontend         â”‚ Auth check   â”‚
â”‚ 2. Auth         â”‚ (local)          â”‚ Backend          â”‚ Error msg    â”‚
â”‚ 3. Stripe Call  â”‚ POST /checkout   â”‚ Backend â†’ Stripe â”‚ Checkout URL â”‚
â”‚ 4. Checkout     â”‚ GET              â”‚ User â†’ Stripe    â”‚ Payment form â”‚
â”‚ 5. Payment      â”‚ POST             â”‚ User â†’ Stripe    â”‚ Paid âœ“       â”‚
â”‚ 6. Webhook      â”‚ POST /webhook    â”‚ Stripe â†’ Backend â”‚ DB updated   â”‚
â”‚ 7. Success      â”‚ GET              â”‚ Frontend         â”‚ Redirect âœ“   â”‚
â”‚ 8. Re-login     â”‚ POST /           â”‚ Frontend         â”‚ Auth ok âœ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Points de SÃ©curitÃ©

```
âœ… VÃ©rification de signature webhook Stripe
   â””â”€ STRIPE_WEBHOOK_SECRET utilisÃ© pour valider les webhooks

âœ… ClÃ©s API Stripe sÃ©curisÃ©es
   â””â”€ Jamais exposÃ©es au frontend
   â””â”€ StockÃ©es dans des variables d'environnement

âœ… Authentification utilisateur
   â””â”€ Mot de passe hashÃ© et salÃ©
   â””â”€ Session crÃ©Ã©e cÃ´tÃ© serveur

âœ… Communication HTTPS
   â””â”€ Stripe Checkout en HTTPS
   â””â”€ Webhooks vÃ©rifiÃ©s par signature

âœ… VÃ©rification de l'abonnement
   â””â”€ Ã€ chaque login
   â””â”€ Via BD externe fiable
```

---

## ğŸ“ˆ Logs Attendus

```
[LOGIN]
    Login blocked for test: Votre abonnement a expirÃ©...

[NAVIGATION]
    (Navigation cÃ´tÃ© client, pas de log)

[STRIPE]
    Redirecting to Stripe checkout: https://checkout.stripe.com/pay/cs_xxx

[WEBHOOK]
    Webhook received: event_type=checkout.session.completed
    Session ID: cs_xxx
    Client: test@example.com
    Plan: annuel
    Amount: 49900 cents

[DB UPDATE]
    UPDATE abonnements SET date_fin_essai='2027-01-21', statut='actif' 
    WHERE client_id='test@example.com'

[REDIRECT]
    (Redirection automatique vers /payment-success)

[RE-LOGIN]
    User logged in: test
```

---

## âœ¨ Cas SpÃ©ciaux

### âŒ Abonnement DÃ©jÃ  Actif
```
â†’ Pas de redirection vers /renew-subscription
â†’ Connexion normale
```

### âŒ Abonnement Inexistant
```
â†’ Redirection vers /renew-subscription
â†’ Message: "Aucun abonnement actif..."
```

### âŒ Webhook Non ReÃ§u
```
â†’ BD non mise Ã  jour
â†’ Utiliser /payment-success?manual_check=true pour forcer la vÃ©rification
â†’ Ou re-vÃ©rifier les paramÃ¨tres webhooks Stripe
```

### âŒ Paiement Ã‰chouÃ©
```
â†’ Redirection vers /payment-cancelled
â†’ BD non modifiÃ©e
â†’ Utilisateur peut rÃ©essayer en cliquant "RÃ©essayer"
```
